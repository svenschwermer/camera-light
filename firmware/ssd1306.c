#include <avr/pgmspace.h>
#include "twi.h"
#include "ssd1306.h"

static const uint8_t WIDTH = 128;
static const uint8_t HEIGHT = 32;
static const uint8_t PAGES = HEIGHT / 8;
static const uint8_t address = 0x3c << 1;

// Init sequence
static const uint8_t init[] PROGMEM = {
    0x00, // Control Byte; Co = 0, D/C = 0
    0xae, // Set Display OFF
    0xd5, // Set Display Clock Divide Ratio / Oscillator Frequency
    0x80, // RESET value
    0xa8, // Set Multiplex Ratio
    HEIGHT - 1,
    0xd3,        // Set Display Offset
    0x0,         // no offset
    0x40 | 0x00, // Set Display Start Line = 0
    0x8d,        // Charge Pump Setting
    0x14,        // Enable charge pump during display on
    0x20,        // Set Memory Addressing Mode
    0x01,        // Vertical Addressing Mode
    0xa1,        // Set Segment Re-map: column address 127 is mapped to SEG0
    0xc8,        // Set COM Output Scan Direction: remapped mode; scan from COM[N-1] to COM0
    0xda,        // Set COM Pins Hardware Configuration
    0x02,        // Sequential COM pin configuration, Disable COM Left/Right remap
    0x81,        // Set Contrast Control
    0x8f,
    0xd9, // Set Pre-charge Period
    0xf1, // Phase 2 period: 15 DCLK; Phase 1 period: 1 DCLK
    0xdb, // Set V_COMH Deselect Level
    0x40, // ?
    0xa4, // Entire Display ON: Resume to RAM content display
    0xa6, // Set Normal/Inverse Display: Normal display
    0x2e, // Deactivate scroll
    0xaf, // Set Display ON
};

// clang-format off
// 128 x 8
static const uint8_t clear_page[] PROGMEM = { 0x40,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
// 71 x 16
const uint8_t rgbw_top[] PROGMEM = {0x40,
    0xff, 0xff, 0xff, 0xff, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x86, 0x07, 0xfe, 0xfe, 0x7c, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xe0, 0x0f, 0xf8, 0x3f, 0x3c, 0xf0, 0x0e, 0xc0, 0x06, 0x80, 0x07, 0x80, 0x03, 0x00, 0x03, 0x00,
    0x03, 0x00, 0x03, 0x03, 0x03, 0x03, 0x07, 0x83, 0x06, 0xc3, 0x0e, 0xe3, 0x1c, 0xff, 0x10, 0xff,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x87, 0x03, 0xfe, 0x86, 0x78, 0xfc, 0x00, 0x78,
    0x00, 0x00, 0x01, 0x00, 0x1f, 0x00, 0xff, 0x01, 0xf0, 0x1f, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xe0,
    0x00, 0xfe, 0xc0, 0x1f, 0xfc, 0x03, 0x3f, 0x00, 0x1f, 0x00, 0xfe, 0x00, 0xf0, 0x0f, 0x00, 0x7f,
    0x00, 0xf8, 0x00, 0xc0, 0x00, 0xfc, 0xe0, 0x7f, 0xff, 0x07, 0x7f, 0x00, 0x07, 0x00,
};
// 14 x 8
const uint8_t r_bottom[] PROGMEM = {0x40,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x02,
};
// 14 x 8
const uint8_t r_bottom_sel[] PROGMEM = {0x40,
    0xe3, 0xe3, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe3, 0xe3, 0xe2,
};
// 16 x 8
const uint8_t g_bottom[] PROGMEM = {0x40,
    0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x01, 0x03,
};
// 16 x 8
const uint8_t g_bottom_sel[] PROGMEM = {0x40,
    0xe0, 0xe0, 0xe0, 0xe1, 0xe1, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe1, 0xe1, 0xe0, 0xe1, 0xe3,
};
// 13 x 8
const uint8_t b_bottom[] PROGMEM = {0x40,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00,
};
// 13 x 8
const uint8_t b_bottom_sel[] PROGMEM = {0x40,
    0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe1, 0xe1, 0xe0,
};
// 22 x 8
const uint8_t w_bottom[] PROGMEM = {0x40,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00,
};
// 22 x 8
const uint8_t w_bottom_sel[] PROGMEM = {0x40,
    0xe0, 0xe0, 0xe0, 0xe0, 0xe1, 0xe3, 0xe3, 0xe1, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe3,
    0xe3, 0xe3, 0xe0, 0xe0, 0xe0, 0xe0,
};
// 11 x 24
const uint8_t digits[][34] PROGMEM = {
    {0x40,
        0xe0, 0x3f, 0x00, 0xf8, 0xff, 0x00, 0x3c, 0xc0, 0x01, 0x0e, 0x80, 0x03, 0x06, 0x00, 0x03, 0x06,
        0x00, 0x03, 0x06, 0x00, 0x03, 0x0e, 0x80, 0x03, 0x3c, 0xe0, 0x01, 0xf8, 0xff, 0x00, 0xe0, 0x3f,
        0x00,
    },
    {0x40,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x30, 0x00, 0x00, 0x38, 0x00, 0x00, 0xfc,
        0xff, 0x03, 0xfe, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00,
    },
    {0x40,
        0x30, 0x80, 0x03, 0x3c, 0xe0, 0x03, 0x0c, 0x30, 0x03, 0x06, 0x18, 0x03, 0x06, 0x18, 0x03, 0x06,
        0x0c, 0x03, 0x06, 0x0c, 0x03, 0x0e, 0x06, 0x03, 0x1c, 0x07, 0x03, 0xfc, 0x03, 0x03, 0xf0, 0x01,
        0x03,
    },
    {0x40,
        0x38, 0x60, 0x00, 0x3c, 0xe0, 0x01, 0x0e, 0x80, 0x01, 0x06, 0x00, 0x03, 0x06, 0x03, 0x03, 0x06,
        0x03, 0x03, 0x06, 0x03, 0x03, 0x8e, 0x83, 0x03, 0xfc, 0x87, 0x01, 0xf8, 0xfc, 0x00, 0x00, 0x78,
        0x00,
    },
    {0x40,
        0x00, 0x38, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x37, 0x00, 0x80, 0x31, 0x00, 0xe0, 0x30, 0x00, 0x70,
        0x30, 0x00, 0x1c, 0x30, 0x00, 0xfe, 0xff, 0x03, 0xfe, 0xff, 0x03, 0x00, 0x30, 0x00, 0x00, 0x30,
        0x00,
    },
    {0x40,
        0x00, 0xc1, 0x00, 0xfc, 0xc1, 0x01, 0xfe, 0x81, 0x01, 0x86, 0x00, 0x03, 0xc6, 0x00, 0x03, 0xc6,
        0x00, 0x03, 0xc6, 0x00, 0x03, 0xc6, 0x81, 0x03, 0x86, 0xc3, 0x01, 0x06, 0xff, 0x00, 0x00, 0x7e,
        0x00,
    },
    {0x40,
        0xc0, 0x3f, 0x00, 0xf8, 0xff, 0x00, 0x1c, 0xc7, 0x01, 0x0c, 0x83, 0x03, 0x86, 0x01, 0x03, 0x86,
        0x01, 0x03, 0x86, 0x01, 0x03, 0x86, 0x81, 0x03, 0x1c, 0xc7, 0x01, 0x1c, 0xff, 0x00, 0x10, 0x7c,
        0x00,
    },
    {0x40,
        0x06, 0x00, 0x00, 0x06, 0x00, 0x00, 0x06, 0x00, 0x03, 0x06, 0xe0, 0x03, 0x06, 0xfc, 0x00, 0x06,
        0x0f, 0x00, 0x86, 0x03, 0x00, 0xe6, 0x00, 0x00, 0x36, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x06, 0x00,
        0x00,
    },
    {0x40,
        0x00, 0x78, 0x00, 0x78, 0xfc, 0x00, 0xfc, 0x87, 0x01, 0x8e, 0x07, 0x03, 0x06, 0x03, 0x03, 0x06,
        0x03, 0x03, 0x06, 0x03, 0x03, 0x8e, 0x07, 0x03, 0xfc, 0x87, 0x01, 0x78, 0xfc, 0x00, 0x00, 0x78,
        0x00,
    },
    {0x40,
        0xf0, 0x41, 0x00, 0xf8, 0xc7, 0x01, 0x1c, 0x86, 0x01, 0x0e, 0x0c, 0x03, 0x06, 0x0c, 0x03, 0x06,
        0x0c, 0x03, 0x06, 0x0c, 0x03, 0x0e, 0x86, 0x01, 0x1c, 0xc7, 0x01, 0xf8, 0xff, 0x00, 0xe0, 0x1f,
        0x00,
    },
};
// clang-format on

static void set_area(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1);
static void clear(void);

void ssd1306_init(void)
{
    twi_init(TWI_BAUD(F_CPU, 100000ul));
    twi_write(address, init, sizeof(init));
    clear();

    set_area(0, 1, 70, 2);
    twi_write(address, rgbw_top, sizeof(rgbw_top));
    ssd1306_r(false);
    ssd1306_g(false);
    ssd1306_b(false);
    ssd1306_w(false);
}

void ssd1306_r(bool selected)
{
    set_area(0, 3, 13, 3);
    if (selected)
        twi_write(address, r_bottom_sel, sizeof(r_bottom_sel));
    else
        twi_write(address, r_bottom, sizeof(r_bottom));
}

void ssd1306_g(bool selected)
{
    set_area(16, 3, 31, 3);
    if (selected)
        twi_write(address, g_bottom_sel, sizeof(g_bottom_sel));
    else
        twi_write(address, g_bottom, sizeof(g_bottom));
}

void ssd1306_b(bool selected)
{
    set_area(35, 3, 47, 3);
    if (selected)
        twi_write(address, b_bottom_sel, sizeof(b_bottom_sel));
    else
        twi_write(address, b_bottom, sizeof(b_bottom));
}

void ssd1306_w(bool selected)
{
    set_area(49, 3, 70, 3);
    if (selected)
        twi_write(address, w_bottom_sel, sizeof(w_bottom_sel));
    else
        twi_write(address, w_bottom, sizeof(w_bottom));
}

void ssd1306_num(uint8_t val)
{
    for (uint8_t i = 0; i < 3; ++i)
    {
        set_area(117 - i * 13, 1, 127 - i * 13, 3);
        twi_write(address, digits[val % 10], sizeof(digits[0]));
        val /= 10;
    }
}

static void set_area(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1)
{
    static uint8_t data[] = {0x00, 0x21, 0x00, 0x00, 0x22, 0x00, 0x00};
    // wait for the last transaction to complete before we overwrite the buffer
    twi_wait();
    data[2] = x0;
    data[3] = x1;
    data[5] = y0;
    data[6] = y1;
    twi_write(address, data, sizeof(data));
}

static void clear(void)
{
    for (uint8_t i = 0; i < PAGES; ++i)
    {
        set_area(0, i, WIDTH - 1, i);
        twi_write(address, clear_page, sizeof(clear_page));
    }
}
